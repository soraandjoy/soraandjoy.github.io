<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Orders Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>body{background:#f8fafc;} .card{border-radius:14px;background:white;padding:18px;box-shadow:0 4px 10px rgba(0,0,0,.05);} .kpi{font-size:24px;font-weight:700;} .kpi-sub{font-size:12px;color:#555;} select,input{border-radius:10px;border:1px solid #ddd;padding:8px;width:100%;}</style>
</head>
<body class="min-h-screen p-4">

<h1 class="text-2xl font-bold mb-4">주문 현황 대시보드</h1>
<div class="card mb-4">
  <label class="text-sm text-gray-600">Google Sheets CSV URL</label>
  <input id="csvUrl" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6Lbqv18MZLm9u-M1INVbWztFTMIf0ycP3dm8C49cPYsZ-amxXnGcRcyDl43XGrkUjaFDmYnmYRLue/pub?gid=0&single=true&output=csv" />
  <button id="refreshBtn" class="mt-2 bg-black text-white px-3 py-2 rounded-lg">Refresh</button>
  <div id="lastUpdated" class="text-xs text-gray-500 mt-1"></div>
</div>

<div class="card mb-4">
  <label class="text-sm text-gray-600">파트 선택</label>
  <select id="partSelect"></select>
</div>

<div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4" id="kpiBox">
  <div class="card"><div class="kpi" id="kpiTotal">0</div><div class="kpi-sub">총 주문</div></div>
  <div class="card"><div class="kpi" id="kpiDelivered">0</div><div class="kpi-sub">Delivered</div></div>
  <div class="card"><div class="kpi" id="kpiNotDelivered">0</div><div class="kpi-sub">미배송</div></div>
  <div class="card"><div class="kpi" id="kpiCost">$0</div><div class="kpi-sub">총 Cost</div></div>
  <div class="card"><div class="kpi" id="kpiPaid">$0</div><div class="kpi-sub">Paid</div></div>
  <div class="card"><div class="kpi" id="kpiUnpaid">$0</div><div class="kpi-sub">미수금</div></div>
</div>

<div class="card mb-4"><canvas id="deliveryChart" height="120"></canvas></div>
<div class="card mb-4"><canvas id="paymentChart" height="120"></canvas></div>

<div class="card overflow-auto"><table id="dataTable" class="text-sm"></table></div>

<script>
const state={csvUrl:document.getElementById("csvUrl").value.trim(),rows:[],headers:[],mapping:{},deliveryChart:null,paymentChart:null};
const CAND={part:["part","pn","item","sku"],delivered:["delivered","status","ship"],cost:["cost","amount","total","price"],paidBool:["paid","payment"],paidAmount:["paid amount","amount paid"],balance:["balance","due","outstanding"]};
const TRUE=['y','yes','true','1','paid','delivered','complete'];
const clean=v=>v==null?"":String(v).trim(); const toL=s=>clean(s).toLowerCase(); const parseMoney=v=>{let s=clean(v).replace(/[$,]/g,'');let n=parseFloat(s);return isNaN(n)?0:n;};
function detectColumns(h){let l=h.map(x=>toL(x));function f(keys){for(let k of keys){for(let i=0;i<l.length;i++){if(l[i].includes(k))return h[i];}}return null;}return{part:f(CAND.part),delivered:f(CAND.delivered),cost:f(CAND.cost),paidBool:f(CAND.paidBool),paidAmount:f(CAND.paidAmount),balance:f(CAND.balance)};}
function unique(a){return [...new Set(a.filter(Boolean))].sort();}
function buildPart(){let sel=document.getElementById('partSelect'); let p=state.mapping.part?unique(state.rows.map(r=>clean(r[state.mapping.part]))):[]; sel.innerHTML='<option value="">모든 파트</option>'+p.map(x=>`<option>${x}</option>`).join('');}
function filterRows(){let p=document.getElementById('partSelect').value; return state.rows.filter(r=>!p||clean(r[state.mapping.part])===p);}
function calc(f){let m=state.mapping;let t=f.length,d=0;f.forEach(r=>{let v=r[m.delivered];if(v&& (TRUE.includes(toL(v))||toL(v)==='delivered'))d++;});let nd=t-d;
let costs=m.cost?f.map(r=>parseMoney(r[m.cost])):f.map(()=>0);let tc=costs.reduce((a,b)=>a+b,0);let ps=0,us=0;
if(m.paidAmount){ps=f.map(r=>parseMoney(r[m.paidAmount])).reduce((a,b)=>a+b,0);if(m.balance)us=f.map(r=>parseMoney(r[m.balance])).reduce((a,b)=>a+b,0);else us=Math.max(0,tc-ps);} else if(m.paidBool&&m.cost){f.forEach((r,i)=>{let p=TRUE.includes(toL(r[m.paidBool]))||toL(r[m.paidBool])==='paid';if(p)ps+=costs[i];else us+=costs[i];});}
return{t,d,nd,tc,ps,us};}
function fmt(n){return n.toLocaleString(undefined,{style:'currency',currency:'USD'});} function updK(s){kpiTotal.textContent=s.t;kpiDelivered.textContent=s.d;kpiNotDelivered.textContent=s.nd;kpiCost.textContent=fmt(s.tc);kpiPaid.textContent=fmt(s.ps);kpiUnpaid.textContent=fmt(s.us);} 
function chart(ref,ctx,l,v){if(ref)ref.destroy();return new Chart(ctx,{type:'doughnut',data:{labels:l,datasets:[{data:v}]},options:{plugins:{legend:{position:'bottom'}}}});} 
function table(f){let h=state.headers;dataTable.innerHTML='<thead><tr>'+h.map(x=>`<th>${x}</th>`).join('')+'</tr></thead><tbody>'+f.map(r=>'<tr>'+h.map(x=>`<td>${clean(r[x])}</td>`).join('')+'</tr>').join('')+'</tbody>';} 
async function loadCsv(url){try{const txt=await (await fetch(url+`&cb=${Date.now()}`,{mode:'cors'})).text();return Papa.parse(txt,{header:true});}catch{const p=`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;const txt=await (await fetch(p)).text();return Papa.parse(txt,{header:true});}}
async function fetchAndRender(){try{let res=await loadCsv(state.csvUrl);state.rows=res.data.filter(r=>Object.values(r).some(v=>clean(v)!==''));state.headers=res.meta.fields;state.mapping=detectColumns(state.headers);buildPart();let f=filterRows();let s=calc(f);updK(s);state.deliveryChart=chart(state.deliveryChart,deliveryChart,['Delivered','미배송'],[s.d,s.nd]);state.paymentChart=chart(state.paymentChart,paymentChart,['Paid','미수금'],[s.ps,s.us]);table(f);lastUpdated.textContent='Updated: '+new Date().toLocaleString();}
catch(e){alert(`CSV 오류:\nGoogle Sheets → "웹에 게시" 되었는지 확인\n링크가 output=csv인지 확인\n\n에러: ${e.message||e}`);} }
document.getElementById('refreshBtn').onclick=fetchAndRender;document.getElementById('partSelect').onchange=fetchAndRender;
fetchAndRender();
</script>
</body>
</html>
